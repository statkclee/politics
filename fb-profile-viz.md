# 데이터 과학자와 함께 하는 제19대 대통령 선거



## 페북 친구 네트워크 시각화 [^kateo-facebook-viz] [^facebook-igraph]

[^facebook-igraph]: [How to analyze your Facebook friends network with R](http://blog.revolutionanalytics.com/2013/11/how-to-analyze-you-facebook-friends-network-with-r.html)

페북 친구 네트워크를 시각화하는 코드는 지속적으로 진화를 해왔다. `igraph`를 활용하여 정적 네트워크 그래프 시각화 방법을 지나서,

[rthreejs](https://github.com/bwlewis/rthreejs)를 활용하여 웹브라우져에서도 정말 가볍게 네트워크 시각화가 가능하게 되었다.

1. `getNetwork()` 함수를 활용해서 본인 네트워크 정보를 가져온다.
1. `graph_from_adjacency_matrix` 함수로 인접행렬(Adjacent Matrix)을 `igraph` 객체로 변환한다.
    - `igraph` 함수 `degree` 정보를 추가한다.
1. 3D 자바스크립트 [three.js](https://threejs.org/)를 R에서 구현한 `threejs` 팩키지 `graphjs` 함수를 활용하여 3차원 시각화한다.


~~~{.r}
# 0. 환경설정 ---------------------------------------------------
## 0.1. 팩키지 불러오기

## 0.2. 토큰 설정
me_token <- "EAACEdEose0cBAFJbE5lwlt8s9lbZAmx5Nsrw5W4FgXraBViIqHi4L4MYXJ6bVlhYo4HG2ZBwyK8ZCTzr5bqLLK9xeZA1qeRHj8XmwOU1rDNM2zOAEmiZAQZBHgD3HYZChf9xEWZBoaZBpEpT2O8zEZChsjoMLkByZCXQqAg9XHgxFGp2FlcClZBl6MwGJg1gIkvK6lQZD"

# 1. 데이터 긁어오기 ---------------------------------------------------

my_network <- getNetwork(token = me_token, format="adj.matrix")
~~~



~~~{.output}
Only friends who use the application will be returned
See ?getFriends for more details

~~~



~~~{.output}

  |                                                                       
  |                                                                 |   0%
  |                                                                       
  |=                                                                |   2%
  |                                                                       
  |===                                                              |   4%
  |                                                                       
  |====                                                             |   6%
  |                                                                       
  |=====                                                            |   8%
  |                                                                       
  |======                                                           |  10%
  |                                                                       
  |========                                                         |  12%
  |                                                                       
  |=========                                                        |  14%
  |                                                                       
  |==========                                                       |  16%
  |                                                                       
  |===========                                                      |  18%
  |                                                                       
  |=============                                                    |  20%
  |                                                                       
  |==============                                                   |  22%
  |                                                                       
  |===============                                                  |  24%
  |                                                                       
  |=================                                                |  25%
  |                                                                       
  |==================                                               |  27%
  |                                                                       
  |===================                                              |  29%
  |                                                                       
  |====================                                             |  31%
  |                                                                       
  |======================                                           |  33%
  |                                                                       
  |=======================                                          |  35%
  |                                                                       
  |========================                                         |  37%
  |                                                                       
  |=========================                                        |  39%
  |                                                                       
  |===========================                                      |  41%
  |                                                                       
  |============================                                     |  43%
  |                                                                       
  |=============================                                    |  45%
  |                                                                       
  |===============================                                  |  47%
  |                                                                       
  |================================                                 |  49%
  |                                                                       
  |=================================                                |  51%
  |                                                                       
  |==================================                               |  53%
  |                                                                       
  |====================================                             |  55%
  |                                                                       
  |=====================================                            |  57%
  |                                                                       
  |======================================                           |  59%
  |                                                                       
  |========================================                         |  61%
  |                                                                       
  |=========================================                        |  63%
  |                                                                       
  |==========================================                       |  65%
  |                                                                       
  |===========================================                      |  67%
  |                                                                       
  |=============================================                    |  69%
  |                                                                       
  |==============================================                   |  71%
  |                                                                       
  |===============================================                  |  73%
  |                                                                       
  |================================================                 |  75%
  |                                                                       
  |==================================================               |  76%
  |                                                                       
  |===================================================              |  78%
  |                                                                       
  |====================================================             |  80%
  |                                                                       
  |======================================================           |  82%
  |                                                                       
  |=======================================================          |  84%
  |                                                                       
  |========================================================         |  86%
  |                                                                       
  |=========================================================        |  88%
  |                                                                       
  |===========================================================      |  90%
  |                                                                       
  |============================================================     |  92%
  |                                                                       
  |=============================================================    |  94%
  |                                                                       
  |==============================================================   |  96%
  |                                                                       
  |================================================================ |  98%
  |                                                                       
  |=================================================================| 100%

~~~



~~~{.r}
# 2. 시각화 위한 데이터 변환 ---------------------------------------------------
# 인접행렬(Adjacent Matrix)를 igraph 객체로 변환
my_network_g <- graph_from_adjacency_matrix(my_network, weighted=TRUE)

my_network_g$degree <- degree(my_network_g)

# 3. 시각화 ---------------------------------------------------
# threejs 동적 페이스북 그래프
graphjs(my_network_g, 
        layout=layout_with_fr(my_network_g, dim=3), 
        vertex.label.cex=0.5,
        edge.arrow.size=1,
        edge.curved=TRUE,
        vertex.size = jsonlite::toJSON(my_network_g$degree/20),
        vertex.color="darkkhaki",
        edge.color="darkgrey",
        vertex.label=V(my_network_g)$name)
~~~

<!--html_preserve--><div id="htmlwidget-95c2b35c7ca0eabd3687" style="width:672px;height:480px;" class="scatterplotThree html-widget"></div>
<script type="application/json" data-for="htmlwidget-95c2b35c7ca0eabd3687">{"x":{"NROW":52,"height":null,"width":null,"axis":false,"numticks":[6,6,6],"xticklabs":null,"yticklabs":null,"zticklabs":null,"color":["#BDB76B"],"size":[0.7,0,0.95,0.2,0,0.65,0.3,0.2,0,0,0.4,0,0.05,0.75,0.5,0.6,0.65,0.45,0.6,0,0.55,0.1,0.5,0.05,0.1,0,0.1,0,0,0.55,0.4,0.15,0.35,0.3,0.15,0.7,0.45,0.4,0.25,0.5,0,0.55,0,0.35,0.2,0.3,0.45,0.45,0.8,0.4,0.3,0.1],"stroke":"black","flipy":true,"grid":false,"renderer":"auto","signif":8,"bg":"white","cexsymbols":1,"xlim":[-1,1],"ylim":[-1,1],"zlim":[-1,1],"pch":["@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@","@"],"from":[[0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,5,5,5,5,5,5,5,5,6,6,10,10,10,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,15,15,15,15,15,15,15,16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,18,18,18,20,20,20,20,20,20,21,22,22,22,22,22,29,29,29,29,29,29,30,30,30,31,32,32,33,34,35,35,35,35,35,35,35,35,35,36,36,36,36,37,37,37,37,38,38,39,39,39,39,39,41,41,41,41,41,41,43,43,45,45,45,46,46,46,46,47,47,47,47,48,48,48,48,48,48,48,48,48,48,48,49,49,49,50,50,50,51]],"to":[[10,16,20,29,35,39,43,47,51,5,10,13,16,17,18,29,32,33,35,38,39,41,49,14,2,7,15,16,26,33,36,38,16,39,22,43,48,6,10,15,20,22,33,34,43,44,50,3,15,20,22,44,5,7,13,14,18,30,35,0,5,6,12,22,29,39,44,29,32,41,48,2,5,20,23,24,30,45,0,13,14,24,36,46,45,6,10,14,31,39,0,16,17,18,33,36,15,46,48,22,17,46,13,45,2,3,7,14,15,26,30,33,36,5,29,35,50,41,46,48,49,2,47,2,3,6,31,44,17,32,37,46,47,49,48,50,18,21,34,20,30,32,37,0,38,41,49,7,10,17,18,30,32,35,37,43,47,49,37,41,47,13,36,43,0]],"lwd":1,"linealpha":1,"center":true,"main":[""],"vertexlabelcex":0.5,"edgearrowsize":1,"edgecurved":true,"lcol":["#A9A9A9"],"labels":["Youngjae Kim","Vance Han","Sung Kim","Kwon-Han Bae","Young-Suk Ahn","Jason Han","Junshik Jeon","Chungil Chae","Seungil Han","홍영택","Youngwook Kim","Won Soon Park","Jiwon Park","Terry Cho","Hyunsik Choi","Jin Young Kim","Hika Maeng","HeeChul Kim","Dylan Ko","ByungSik Choi","Yun Her","Jungin Yi","Chulhyun Cho","Song Yeong-min","Kwang Shick Kim","Ji-Won Chun","Choonghyun Ryu","Michael Lammbrau","Jaehee Hwang","Yongho Ha","Chan Yub Park","양충현","Sangjin Sim","Sabum Jung","이준영","정우준","Soo Kyung Lee","박경원","오민석","Dae Myung Clark Kang","Yunhwan Kim","Paruparo Zumba","김보근","Gyubin Park","한승진","Yong Hyun Kim","이상열","홍길한","Chisung  Song","Brian Lee","Harrison Jung","SungMin Jung"],"alpha":[1],"vertices":[[-0.38007846,-0.015798683,0.096608705,-0.23710654,-1,-0.95694929,-0.47435132,0.020779292,0.22578046,0.030456346,0.056200941,0.4770925,0.70129303,-0.36387585,-0.33002072,-0.4367389,0.11326395,0.28110784,0.1042871,0.026732918,0.057099308,-0.70903284,0.096454031,0.40918348,-0.67229565,0.68508367,-0.75989297,0.50307815,0.76227083,-0.41614774,-0.27312957,0.071047936,0.089498394,0.36424126,1,0.14917383,0.15959344,0.030458253,-0.27509628,-0.1641395,0.11014839,0.28916558,-0.1181742,0.031952952,0.43830804,-0.37332684,0.066519043,0.47774481,-0.14086401,0.038493287,0.079824602,-0.74231297,0.026840048,0.028085842,-0.41414152,-0.025519803,0.57147429,0.85045148,0.34855487,-0.37521742,-0.44314638,0.020874067,0.41979582,0.11677796,-0.24789671,0.99571057,0.066544771,0.015451028,0.1901304,-0.40244634,-0.068745647,1,-0.53748431,0.0039661486,0.81308103,-0.4782581,0.071153512,-1,-0.72411696,0.2941336,0.42262535,0.1154996,0.42307548,-0.9012825,1,-0.18263821,-0.067696057,-0.4458215,0.11307763,0.13184745,-0.66208579,-0.0029337678,0.47448425,0.34475913,-0.056066378,0.18348797,-0.89327087,-0.023172233,0.1846292,-0.26665236,0.2543,0.24342838,0.089806192,-0.089284091,0.68227091,-0.42561601,0.15087178,0.37788684,-0.43717933,0.28804635,0.22014457,-1,-0.030330843,0.10862564,-0.57245731,-0.097789035,0.034790734,-0.047496803,-0.051413391,0.19850144,-0.12979009,0.93519434,-0.55303744,-0.87562001,-0.067855305,0.055550734,0.37159114,-0.16955523,-0.84307258,-0.39739117,0.22726977,0.019266549,0.15035119,-0.0030605251,0.31408508,-0.080665681,-0.17301947,0.80576562,-0.84580485,-0.054890609,0.3362372,-0.6917923,-0.0741234,-0.074863971,-0.65678558,0.050016184,0.17934761,-0.87650226,-0.018411085,-0.053172059,-0.24022204,0.38247962,0.13392282,-0.33560486,-0.25346684,-0.17701057]],"xticklab":["-1.00","-0.60","-0.20","0.20","0.60","1.00"],"yticklab":["-1.00","-0.60","-0.20","0.20","0.60","1.00"],"zticklab":["1.00","0.60","0.20","-0.20","-0.60","-1.00"],"xtick":[0,0.2,0.4,0.6,0.8,1],"ytick":[0,0.2,0.4,0.6,0.8,1],"ztick":[0,0.2,0.4,0.6,0.8,1]},"evals":[],"jsHooks":[]}</script><!--/html_preserve-->

~~~{.r}
# 애니메이션
# graphjs(my_network_g, 
#         layout=list(layout_randomly(my_network_g, dim=3),
#                     layout_on_sphere(my_network_g),
#                     layout_with_drl(my_network_g, dim=3),
#                     layout_with_fr(my_network_g, dim=3)),
#         main=list("random layout", "sphere layout", "drl layout", "fr layout"), fpl=300,
#         vertex.label.cex=0.5,
#         edge.arrow.size=3,
#         edge.curved=TRUE,
#         vertex.size = jsonlite::toJSON(my_network_g$degree/20),
#         vertex.color="darkkhaki",
#         edge.color="darkgrey",
#         vertex.label=V(my_network_g)$name)
~~~

## 페북 친구 프로파일 사진 시각화 [^kateo-facebook-viz]

[^kateo-facebook-viz]: [Facebook data collection and photo network visualization with Gephi and R](http://kateto.net/2014/04/facebook-data-collection-and-photo-network-visualization-with-gephi-and-r/)

페북 친구 네트워크를 친구 프로파일에 있는 사진을 노드에 넣어 시각화하는 것도 상기와 유사한 과정을 거치게 된다.
다만, 친구 사진 다운로드하는 과정이 추가되고 이를 `Gephi`, `igraph`, `qgraph` 등에 담는 과정이 추가될 따름이다.



~~~{.r}
# 0. 환경설정 ---------------------------------------------------
## 0.1. 팩키지 불러오기
#library(png)
#library(jpeg)
#library(igraph)

## 0.2. 토큰 설정
me_token <- "EAACEdEose0cBAFJbE5lwlt8s9lbZAmx5Nsrw5W4FgXraBViIqHi4L4MYXJ6bVlhYo4HG2ZBwyK8ZCTzr5bqLLK9xeZA1qeRHj8XmwOU1rDNM2zOAEmiZAQZBHgD3HYZChf9xEWZBoaZBpEpT2O8zEZChsjoMLkByZCXQqAg9XHgxFGp2FlcClZBl6MwGJg1gIkvK6lQZD"

# 1. 데이터 긁어오기 ---------------------------------------------------
## 1.1. 친구정보 가져오기
my_friends <- getFriends(token=me_token, simplify = FALSE)
~~~



~~~{.output}
Only friends who use the application will be returned
See ?getFriends for more details

~~~



~~~{.r}
## 1.2. 친구네트워크 가져오기
my_network <- getNetwork(token = me_token, format="adj.matrix") + 0
~~~



~~~{.output}
Only friends who use the application will be returned
See ?getFriends for more details

~~~



~~~{.output}

  |                                                                       
  |                                                                 |   0%
  |                                                                       
  |=                                                                |   2%
  |                                                                       
  |===                                                              |   4%
  |                                                                       
  |====                                                             |   6%
  |                                                                       
  |=====                                                            |   8%
  |                                                                       
  |======                                                           |  10%
  |                                                                       
  |========                                                         |  12%
  |                                                                       
  |=========                                                        |  14%
  |                                                                       
  |==========                                                       |  16%
  |                                                                       
  |===========                                                      |  18%
  |                                                                       
  |=============                                                    |  20%
  |                                                                       
  |==============                                                   |  22%
  |                                                                       
  |===============                                                  |  24%
  |                                                                       
  |=================                                                |  25%
  |                                                                       
  |==================                                               |  27%
  |                                                                       
  |===================                                              |  29%
  |                                                                       
  |====================                                             |  31%
  |                                                                       
  |======================                                           |  33%
  |                                                                       
  |=======================                                          |  35%
  |                                                                       
  |========================                                         |  37%
  |                                                                       
  |=========================                                        |  39%
  |                                                                       
  |===========================                                      |  41%
  |                                                                       
  |============================                                     |  43%
  |                                                                       
  |=============================                                    |  45%
  |                                                                       
  |===============================                                  |  47%
  |                                                                       
  |================================                                 |  49%
  |                                                                       
  |=================================                                |  51%
  |                                                                       
  |==================================                               |  53%
  |                                                                       
  |====================================                             |  55%
  |                                                                       
  |=====================================                            |  57%
  |                                                                       
  |======================================                           |  59%
  |                                                                       
  |========================================                         |  61%
  |                                                                       
  |=========================================                        |  63%
  |                                                                       
  |==========================================                       |  65%
  |                                                                       
  |===========================================                      |  67%
  |                                                                       
  |=============================================                    |  69%
  |                                                                       
  |==============================================                   |  71%
  |                                                                       
  |===============================================                  |  73%
  |                                                                       
  |================================================                 |  75%
  |                                                                       
  |==================================================               |  76%
  |                                                                       
  |===================================================              |  78%
  |                                                                       
  |====================================================             |  80%
  |                                                                       
  |======================================================           |  82%
  |                                                                       
  |=======================================================          |  84%
  |                                                                       
  |========================================================         |  86%
  |                                                                       
  |=========================================================        |  88%
  |                                                                       
  |===========================================================      |  90%
  |                                                                       
  |============================================================     |  92%
  |                                                                       
  |=============================================================    |  94%
  |                                                                       
  |==============================================================   |  96%
  |                                                                       
  |================================================================ |  98%
  |                                                                       
  |=================================================================| 100%

~~~



~~~{.r}
my_network_el <- as.data.frame(getNetwork(token = me_token, format = "edgelist"))
~~~



~~~{.output}
Only friends who use the application will be returned
See ?getFriends for more details

~~~



~~~{.output}

  |                                                                       
  |                                                                 |   0%
  |                                                                       
  |=                                                                |   2%
  |                                                                       
  |===                                                              |   4%
  |                                                                       
  |====                                                             |   6%
  |                                                                       
  |=====                                                            |   8%
  |                                                                       
  |======                                                           |  10%
  |                                                                       
  |========                                                         |  12%
  |                                                                       
  |=========                                                        |  14%
  |                                                                       
  |==========                                                       |  16%
  |                                                                       
  |===========                                                      |  18%
  |                                                                       
  |=============                                                    |  20%
  |                                                                       
  |==============                                                   |  22%
  |                                                                       
  |===============                                                  |  24%
  |                                                                       
  |=================                                                |  25%
  |                                                                       
  |==================                                               |  27%
  |                                                                       
  |===================                                              |  29%
  |                                                                       
  |====================                                             |  31%
  |                                                                       
  |======================                                           |  33%
  |                                                                       
  |=======================                                          |  35%
  |                                                                       
  |========================                                         |  37%
  |                                                                       
  |=========================                                        |  39%
  |                                                                       
  |===========================                                      |  41%
  |                                                                       
  |============================                                     |  43%
  |                                                                       
  |=============================                                    |  45%
  |                                                                       
  |===============================                                  |  47%
  |                                                                       
  |================================                                 |  49%
  |                                                                       
  |=================================                                |  51%
  |                                                                       
  |==================================                               |  53%
  |                                                                       
  |====================================                             |  55%
  |                                                                       
  |=====================================                            |  57%
  |                                                                       
  |======================================                           |  59%
  |                                                                       
  |========================================                         |  61%
  |                                                                       
  |=========================================                        |  63%
  |                                                                       
  |==========================================                       |  65%
  |                                                                       
  |===========================================                      |  67%
  |                                                                       
  |=============================================                    |  69%
  |                                                                       
  |==============================================                   |  71%
  |                                                                       
  |===============================================                  |  73%
  |                                                                       
  |================================================                 |  75%
  |                                                                       
  |==================================================               |  76%
  |                                                                       
  |===================================================              |  78%
  |                                                                       
  |====================================================             |  80%
  |                                                                       
  |======================================================           |  82%
  |                                                                       
  |=======================================================          |  84%
  |                                                                       
  |========================================================         |  86%
  |                                                                       
  |=========================================================        |  88%
  |                                                                       
  |===========================================================      |  90%
  |                                                                       
  |============================================================     |  92%
  |                                                                       
  |=============================================================    |  94%
  |                                                                       
  |==============================================================   |  96%
  |                                                                       
  |================================================================ |  98%
  |                                                                       
  |=================================================================| 100%

~~~



~~~{.r}
## 1.3. 친구 사진 다운로드 -----------------------------------------------------------------
dir.create("FbImages")

my_friends$picture.dld <- NA

for (i in 1:dim(my_friends)[1]) { 
  # Fb images 프로파일 사진 거의 대부분이 JPEG
  pic_ext <- ".jpg" 
  if(grepl(".gif$", my_friends$picture[i])) pic_ext <- ".gif"
  
  # 페북사용자 이름에 파일확장자 추가
  my_friends$picture.dld[i] <- paste0("FBImages/", sub(" ", "_", my_friends$name[i]), pic_ext)
  
  # UTF-8 인코딩을 갖지 않는 사용자 처리로직:
  if (Encoding(my_friends$name[i])=="UTF-8") {
    my_friends$picture.dld[i] <- paste0("FBImages/", "FbID_", my_friends$id[i], pic_ext) }
  
  download.file(my_friends$picture[i],  my_friends$picture.dld[i],  mode = 'wb')  
}

# 사진 정보 저장
colnames(my_network_el) <- c("Source", "Target")
my_friends$ID <- my_friends$name
my_friends$image <- gsub("FBImages/(*.)", "\\1", my_friends$picture.dld)

# write.csv(my_network_el, file="Facebook-friend-EDGES.csv", row.names=F)
# write.csv(my_friends, file="Facebook-friend-NODES.csv", row.names=F)

# 2. 네트워크 데이터 준비 ---------------------------------------------------

fb_net <- graph.adjacency(my_network)

my_friends$degree <- degree(fb_net)
my_friends$color <- "gray45"
my_friends$color[my_friends$gender=="female"] <- "lightpink3"
my_friends$color[my_friends$gender=="male"]   <- "lightblue"
my_network_el$color <- my_friends$color[match(my_network_el$Source, my_friends$name)]
~~~

시각화를 위해 사진이 들어가지 않는 그래프와 사진이 들어간 그래프를 넣어 시각화한다.


~~~{.r}
# 3. 페북 프로파일 사진 시각화 ---------------------------------------------------

## 3.1. 사진없이 시각화
l <- layout.fruchterman.reingold(fb_net, niter=10000, 
                                 area=vcount(fb_net)^2.3,
                                 repulserad=vcount(fb_net)^2.65)
~~~



~~~{.output}
Warning in layout_with_fr(structure(list(52, TRUE, c(0, 0, 0, 0, 0, 0, 0, :
Argument `area' is deprecated and has no effect

~~~



~~~{.output}
Warning in layout_with_fr(structure(list(52, TRUE, c(0, 0, 0, 0, 0, 0, 0, :
Argument `repulserad' is deprecated and has no effect

~~~



~~~{.r}
plot(fb_net, vertex.size=my_friends$degree/20, vertex.label=NA, 
     vertex.color=my_friends$color, edge.color=my_network_el$color,
     edge.width=1, edge.arrow.size=0, edge.curved=0.3,  layout=l)
~~~

<img src="fig/fb-network-igraph-viz-1.png" style="display: block; margin: auto;" />

~~~{.r}
## 3.2. 프로필 사진 넣어 시각화
# 레이아웃 -1에서 1로 척도 재조정
l <- layout.norm(l, -1, 1, -1, 1)

plot(fb_net, vertex.size=4, vertex.label=NA, edge.color=my_network_el$color, 
     vertex.shape="square",vertex.color="white", vertex.frame.color="white",
     edge.width=1.5, edge.arrow.size=0, edge.curved=0.2,  layout=l)

img.sc <- 0.05 #Image scaling
for (i in 1:dim(l)[1]) {
  img <- my_friends$picture.dld[i]
  img <- if(grepl(".jpg", img)) readJPEG(img) else "gray20"
  rasterImage(img, l[i,1]-img.sc, l[i,2]-img.sc, l[i,1]+img.sc, l[i,2]+img.sc)
}
~~~

<img src="fig/fb-network-igraph-viz-2.png" style="display: block; margin: auto;" />
